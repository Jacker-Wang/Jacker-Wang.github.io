---
layout: "post"
title: "快速搭建Ambari和相关集群"
date: "2017-12-04 14:24"
---

# 环境准备
## 平台环境
平台所有机器均为（CentOS7.2，16核|128GB），此平台有8太机器，3台机器作为管理节点，5台作为数据节点，具体分配如：

IP(私有IP)  |节点说明   | 节点服务
--|---|--
172.16.100.37  |  master1 | ambari-server，zookeeper,HbaseMaster
172.16.100.241  |  master2 |ambari-agent, zookeeper,HbaseMaster
172.16.100.225  |  master3 |ambari-agent,  zookeeper,HbaseMaster
172.16.100.174  |  slave1 |ambari-agent
172.16.100.242  |  slave2 |ambari-agent
  172.16.100.3|  slave3 |ambari-agent
172.16.100.198  | slave4  |ambari-agent
172.16.100.106  | slave5  |ambari-agent

## 预安装
因为这里需要在8台机器上执行相同的操作，所有的操作尽量以shell脚本的形式运行

一： 拿到一台新机器需要先挂在硬盘
挂载硬盘的步骤如下：

分配和挂载硬盘之前使用df -TH和fdisk -l查看当前硬盘以及挂载的情况，然后以此为根据对硬盘进行分区和选择相应目录进行挂载。这里fdisk -l查看到还有4T大小的硬盘/dev/xvde未分区

```
#安装fuser命令用于kill对应硬盘的进程（用于分区的卸载）
yum -y install psmisc

#硬盘分区
fdisk /dev/xvde
：n(添加新分区)
：p(注明是主分区)
：回车（默认的起始扇区）
：+500G(分区大小为500G)
：w（将改变写入）

#格式化分区
mkfs -t ext4(ext3) -c /dev/xdve1
ext4为设定的文件系统格式。这里需要等待waiting...........

#挂在分区到相应的文件系统目录
 mkdir /data
 mount /dev/xvde1 /data
```

二：免密登录
这里需要3台master能够免密ssh登录到所有其它的主机，免密登录脚本如下：

vim copyIdToCluster.sh
```
#若没有配置/etc/hosts文件，需要将主机名改为对应的内网ip
hosts=(m1 m2 m3 s1 s2 s3 s4 s5)
ssh-keygen -t rsa
count=0
for host in ${hosts[*]}
do
    server=$host
    ssh-copy-id -i /root/.ssh/id_rsa.pub $host
    ((count++))
done
echo "复制文件数目 $count "
```
执行copyIdToCluster.sh,根据提示输入机器密码即可完成此机器到所有其它机器的免密登录。由于其它3台机器也需要相同操作，这里使用文件复制脚本完成脚本copyIdToCluster.sh到其它3台master的复制。复制脚本如下：

vim cpFileToCluster.sh
```
hosts=(m1 m2 m3 s1 s2 s3 s4 s5)
currentPath=`pwd`
argPath=$1
if [ ${argPath:0:1} != "/" ]
then
    argPath=${currentPath}"/"${argPath}
fi

#根据原文件路径获得目的文件路径（父目录）
destDir=${argPath%/*}
echo "目标目录为>>>$destDir<<<"

for host in ${hosts[*]}
do
    echo "复制文件  $argPath->$host:$desDir"
    scp $argPath root@$host:$destDir
    if [ ${argPath##*.} = "sh" ]
    then
        echo "执行文件 $argPath"
        ssh $host "sh $argPath"
    fi
done
```
执行以下命令完成脚本文件的复制和异地执行
chmod 755 cpFileToCluster.sh
cpFileToCluster.sh copyIdToCluster.sh

三：配置/etc/hosts和主机名称

1 修改主机名

在8台机器上分别执行以下命令完成所有机器的名称修改
```
vim /etc/hostname
m1
reboot
```
这里主机名需要重启生效，在后面步骤进行重启。

2 配置/etc/hosts

vim /etc/hosts
```
#添加以下映射关系
172.16.100.37   m1.cluster.com m1
172.16.100.241  m2.cluster.com m2
172.16.100.225  m3.cluster.com m3
172.16.100.174  s1.cluster.com s1
172.16.100.242  s2.cluster.com s2
172.16.100.3    s3.cluster.com s3
172.16.100.198  s4.cluster.com s4
172.16.100.106  s5.cluster.com s5
```
使用复制脚本复制/etc/hosts到所有机器

四：关闭防火墙和SELINUX
1 关闭防火墙
vim stopFireWalld.sh
```
#关闭
service firewalld stop
#随着系统启动自动关闭
chkconfig firewalld off
```
使用复制脚本复制stopFireWalld.sh到所有机器

2 关闭SELINUX

vim /etc/selinux/config

修改 SELINUX=disabled
```
# This file controls the state of SELinux on the system.
# SELINUX= can take one of these three values:
#     enforcing - SELinux security policy is enforced.
#     permissive - SELinux prints warnings instead of enforcing.
#     disabled - No SELinux policy is loaded.
SELINUX=disabled
# SELINUXTYPE= can take one of three two values:
#     targeted - Targeted processes are protected,
#     minimum - Modification of targeted policy. Only selected processes are protected.
#     mls - Multi Level Security protection.
SELINUXTYPE=targeted
```
使用复制脚本复制/etc/selinux/config到所有机器

五：设置最大文件打开数和最大进程数量

vim /etc/security/limits.conf
```
#添加
* - nofile 65536
* - nproc 16384
```
RHEL6之后nproc受到文件/etc/security/limits.d/90-nproc.conf的影响
vim /etc/security/limits.d/90-nproc.conf
```
#修改数字为16384
16384
```
ulimit -a进行检测（需要重新登录生效）

六：关闭THP特性
vim /etc/rc.local
```
#添加
echo never > /sys/kernel/mm/redhat_transparent_hugepage/enabled
echo never > /sys/kernel/mm/redhat_transparent_hugepage/defrag
```
source /etc/rc.local使生效

七：重启机器使主机名生效并检查防火墙状态
```
reboot
```
---
# Ambari搭建
## 搭建本地yum源
一：安装httpd服务

1：在m1上安装httpd服务
```
yum install httpd
#启动httpd
service httpd start
#开机启动
chkconfig httpd on
```

httpd的默认根目录为/var/www/html,在/var/www/html下面新建测试文件index.html

vim index.html
```
<html>
<body>
<div style="width: 100%; font-size: 40px; font-weight: bold; text-align: center;">
Welcome access LinuxProbe.org,This is Test Page!
</div>
</body>
</html>
```

2：在m1和其它机器测试httpd服务是否能够访问
```
curl localhost
```
如果httpd启动成功，则会获取index.html内容

二：配置本地yum源

1：获取相应集群所需要的包

需要的包：

ambari-2.4.2.0-centos7.tar.gz

HDP-2.5.3.0-centos7-rpm.tar.gz

HDP-UTILS-1.1.0.21-centos7.tar.gz

2：在目录/etc/yum.repo.d下面新建yum配置文件

vim /etc/yum.repos.d/ambari.repo
```
[AMBARI-2.4.2.0-136]
name=Ambari 2.x
baseurl=http://172.16.100.37/AMBARI-2.4.2.0/centos7/2.4.2.0-136
gpgcheck=1
gpgkey=http://172.16.100.37/AMBARI-2.4.2.0/centos7/2.4.2.0-136/RPM-GPG-KEY/RPM-GPG-KEY-Jenkins
enabled=1
priority=1

[HDP-UTILS-1.1.0.21]
name=HDP-UTILS Version - HDP-UTILS-1.1.0.21
baseurl=http://172.16.100.37/HDP-UTILS-1.1.0.21/repos/centos7/
gpgcheck=0
gpgkey=http://172.16.100.37/AMBARI-2.4.2.0/centos7/2.4.2.0-136/RPM-GPG-KEY/RPM-GPG-KEY-Jenkins
enabled=1
priority=1

[HDP-2.5.3.0]
name=HDP Version - HDP-2.5.3.0
baseurl=http://172.16.100.37/HDP/centos7/
gpgcheck=1
gpgkey=http://172.16.100.37/AMBARI-2.4.2.0/centos7/2.4.2.0-136/RPM-GPG-KEY/RPM-GPG-KEY-Jenkins
enabled=1
priority=1

[Updates-AMBARI-2.4.2.0-1.4.4.23]
name=AMBARI-2.4.2.0-1.4.4.23 - Updates
baseurl=http://172.16.100.37/AMBARI-2.4.2.0/centos7/2.4.2.0-136
gpgcheck=1
gpgkey=http://172.16.100.37/AMBARI-2.4.2.0/centos7/2.4.2.0-136/RPM-GPG-KEY/RPM-GPG-KEY-Jenkins
enabled=1
priority=1
```
3:yum源检测

执行yum repolist获取相关yum源。

三：安装ambari-server

只需要在m1上安装ambari-server
```
yum install ambari-server
#修改配置文件
vim /etc/ambari-server/conf/ambari.properties
#添加
java.home=$JAVA_HOME
#修改
client.threadpool.size.max = 50
```
四：安装ambari-agent
所有机器安装ambari-agent
vim installAgent.sh
```
yum -y install ambari-agent
#修改配置文件
vim /etc/ambari-agent/conf/ambari-agent.ini
#修改hostname
hostname=m1.cluster.com
```
复制installAgent.sh到所有机器并执行

五：启动ambar-server和ambari-agent
1：设置ambari-server
ambari-server setup
```
ambari-server setup设置ambari-server
Using python  /usr/bin/python2.6
Setup ambari-server
Checking SELinux...
SELinux status is 'enabled'
SELinux mode is 'permissive'
WARNING: SELinux is set to 'permissive' mode and temporarily disabled.
OK to continue [y/n] (y)? y
Customize user account for ambari-server daemon [y/n] (n)? n
Adjusting ambari-server permissions and ownership...
Checking firewall...
Checking JDK...
Do you want to change Oracle JDK [y/n] (n)? n
Completing setup...
Configuring database...
Enter advanced database configuration [y/n] (n)? y
==============================================================================
Choose one of the following options:
[1] - PostgreSQL (Embedded)
[2] - Oracle
[3] - MySQL
[4] - PostgreSQL
==============================================================================
Enter choice (1): 1
Database Name (ambari): ambari
Postgres schema (ambari): ambari
Username (ambari): ambari
Enter Database Password (bigdata): xxxxx
Re-enter password: xxxxx
Default properties detected. Using built-in database.
Checking PostgreSQL...
Running initdb: This may take upto a minute.
Initializing database: [  OK  ]

About to start PostgreSQL
Configuring local database...
Connecting to local database...done.
Configuring PostgreSQL...
Restarting PostgreSQL
Extracting system views...
.ambari-admin-1.7.0.169.jar
.
Adjusting ambari-server permissions and ownership...
Ambari Server 'setup' completed successfully.
```

2：启动ambari-server

service ambari-server start

chkconfig ambari-server on

3：启动所有ambari-agent

service ambari-agent start

六：连接ambari
浏览器输入m1的ip://8080检测

---
# 使用Ambari安装相关集群
使用ambar管理界面安装相关集群即可，剩下工作交给Ambari即可。
---
# Q&A
_**Q:**_
1 ambari注册集群机器的步骤，查看日志文件/var/log/ambari-agent.log:

_ERROR 2017-12-01 15:24:00,991 NetUtil.py:89 - SSLError: Failed to connect. Please check openssl library versions.
_

_**A:**_

所有ambari-agent执行以下命令并重启

sed -i 's/verify=platform_default/verify=disable/' /etc/python/cert-verification.cfg

_**Q:**_
2 ambari-setup的阶段
_/dev/null无权限访问导致postgresql无法启动_

_**A:**_
#删除/dev/null
rm -f /dev/null
#新建不同权限的字符设备文件(面向字符)/dev/null
mknod -m 666 /dev/null c 1 3
